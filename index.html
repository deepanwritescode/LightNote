<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Light Note</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      background: #1a1a1a;
      position: fixed;
      width: 100%;
      height: 100%;
      touch-action: none;
    }

    #canvas {
      display: block;
      width: 100vw;
      height: 100vh;
      cursor: grab;
      background: #1a1a1a;
    }

    #canvas:active {
      cursor: grabbing;
    }

    .context-menu {
      position: fixed;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      padding: 4px 0;
      z-index: 1000;
      min-width: 150px;
    }

    .context-menu-item {
      padding: 14px 20px;
      cursor: pointer;
      font-size: 16px;
      color: #e0e0e0;
    }

    .context-menu-item:hover {
      background: #3a3a3a;
    }

    .note-editor {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2a2a2a;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      width: 500px;
      max-width: 90vw;
      z-index: 2000;
      display: none;
      border: 1px solid #3a3a3a;
    }

    .note-editor.active {
      display: block;
    }

    .note-editor-header {
      padding: 16px 16px 8px 16px;
    }

    .note-editor-title {
      width: 100%;
      border: none;
      outline: none;
      font-size: 18px;
      font-weight: 500;
      padding: 8px 0;
      font-family: inherit;
      background: transparent;
      color: #e0e0e0;
    }

    .note-editor-title::placeholder {
      color: #666;
    }

    .note-editor-body {
      padding: 8px 16px;
    }

    .note-editor-content {
      width: 100%;
      border: none;
      outline: none;
      font-size: 14px;
      min-height: 200px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.5;
      white-space: pre-wrap;
      background: transparent;
      color: #e0e0e0;
    }

    .note-editor-content::placeholder {
      color: #666;
    }

    .linked-text {
      color: #ff69b4;
      text-decoration: underline;
      cursor: pointer;
      background: rgba(124, 58, 237, 0.1);
      padding: 2px 4px;
      border-radius: 3px;
    }

    .linked-text:hover {
      background: rgba(124, 58, 237, 0.2);
    }

    .links-popup {
      position: absolute;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      padding: 8px 0;
      z-index: 2500;
      min-width: 200px;
      max-width: 300px;
    }

    .links-popup-item {
      padding: 10px 16px;
      cursor: pointer;
      font-size: 14px;
      color: #e0e0e0;
      border-bottom: 1px solid #3a3a3a;
    }

    .links-popup-item:last-child {
      border-bottom: none;
    }

    .links-popup-item:hover {
      background: #3a3a3a;
    }

    .links-popup-title {
      font-weight: 600;
      color: #a78bfa;
    }

    .links-popup-text {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }

    .note-editor-toolbar {
      padding: 8px 16px;
      display: flex;
      gap: 8px;
      border-top: 1px solid #3a3a3a;
    }

    .toolbar-btn {
      padding: 6px 12px;
      border: 1px solid #3a3a3a;
      background: #2a2a2a;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #e0e0e0;
    }

    .toolbar-btn:hover {
      background: #3a3a3a;
    }

    .toolbar-btn.active {
      background: #2d1b4e;
      border-color: #7c3aed;
    }

    .note-editor-footer {
      padding: 12px 16px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn {
      padding: 8px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .btn-primary {
      background: #7c3aed;
      color: white;
    }

    .btn-primary:hover {
      background: #6d28d9;
    }

    .btn-secondary {
      background: transparent;
      color: #999;
    }

    .btn-secondary:hover {
      background: #3a3a3a;
    }

    .link-mode-overlay {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1500;
      display: none;
      pointer-events: none;
    }

    .link-mode-overlay.active {
      display: block;
    }

    .link-mode-message {
      background: #2a2a2a;
      padding: 16px 32px;
      border-radius: 8px;
      font-size: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      border: 2px solid #7c3aed;
      color: #e0e0e0;
    }

    .text-selection-mode {
      cursor: text !important;
    }

    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .login-box {
      background: #2a2a2a;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 30px rgba(0,0,0,0.6);
      text-align: center;
      border: 1px solid #3a3a3a;
      max-width: 400px;
    }

    .login-box h1 {
      color: #e0e0e0;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .login-box p {
      color: #999;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .google-signin-btn {
      background: white;
      color: #444;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      transition: box-shadow 0.2s;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }

    .google-signin-btn:active {
      transform: scale(0.98);
    }

    .google-signin-btn:hover {
      box-shadow: 0 2px 8px rgba(255,255,255,0.2);
    }

    .user-info {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2a2a2a;
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid #3a3a3a;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid #7c3aed;
    }

    .user-name {
      color: #e0e0e0;
      font-size: 14px;
      font-weight: 500;
    }

    .logout-btn {
      background: transparent;
      color: #999;
      border: 1px solid #3a3a3a;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 8px;
    }

    .logout-btn:hover {
      background: #3a3a3a;
      color: #e0e0e0;
    }
  </style>
</head>
<body>
  <div id="loginOverlay" class="login-overlay">
    <div class="login-box">
      <h1>Light Note</h1>
      <p>Sign in to access your personal note graph</p>
      <button id="googleSignInBtn" class="google-signin-btn">
        <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/><path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/><path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/><path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/></g></svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <div id="userInfo" class="user-info" style="display: none;">
    <img id="userAvatar" class="user-avatar" src="" alt="User">
    <span id="userName" class="user-name"></span>
    <button id="logoutBtn" class="logout-btn">Sign Out</button>
  </div>

  <canvas id="canvas"></canvas>
  <div id="linkModeOverlay" class="link-mode-overlay">
    <div class="link-mode-message">Select a note to link to</div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // Firebase Configuration & Initialization
    const firebaseConfig = {
      apiKey: "AIzaSyBZdRiJlSLZMqdMCPiRmbv6A-kzFg4dVgs",
      authDomain: "lightnote-coffeecorvid.firebaseapp.com",
      projectId: "lightnote-coffeecorvid",
      storageBucket: "lightnote-coffeecorvid.firebasestorage.app",
      messagingSenderId: "842228608724",
      appId: "1:842228608724:web:5312ed1f38ab05ca461541",
      measurementId: "G-N6M2QS6S00"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    let currentUser = null;

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let notes = [];
    let links = [];
    let camera = { x: 0, y: 0, zoom: 1 };
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let selectedNote = null;
    let contextMenu = null;
    let noteEditor = null;
    let linkMode = null;
    let draggingNote = null;
    let linksPopup = null;
    let hasDragged = false;
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let longPressTimer = null;
    let longPressTarget = null;
    let lastTap = 0;
    let touchStartPos = { x: 0, y: 0 };

    class Note {
      constructor(x, y, title = '', content = '') {
        this.id = Date.now() + Math.random();
        this.x = x;
        this.y = y;
        this.vx = 0;
        this.vy = 0;
        this.title = title;
        this.content = content;
        this.radius = 12;
        this.isDragging = false;
      }
    }

    class Link {
      constructor(from, to, fromText, toText) {
        this.from = from;
        this.to = to;
        this.fromText = fromText;
        this.toText = toText;
      }
    }

    function screenToWorld(sx, sy) {
      return {
        x: (sx - canvas.width / 2) / camera.zoom - camera.x,
        y: (sy - canvas.height / 2) / camera.zoom - camera.y
      };
    }

    function worldToScreen(wx, wy) {
      return {
        x: (wx + camera.x) * camera.zoom + canvas.width / 2,
        y: (wy + camera.y) * camera.zoom + canvas.height / 2
      };
    }

    function applyForces() {
      const repulsion = 4000;
      const attraction = 0.005;
      const damping = 0.85;
      const centerPull = 0.001;

      // Repulsion between all nodes
      for (let i = 0; i < notes.length; i++) {
        if (notes[i].isDragging) continue;
        
        for (let j = i + 1; j < notes.length; j++) {
          if (notes[j].isDragging) continue;
          
          const dx = notes[j].x - notes[i].x;
          const dy = notes[j].y - notes[i].y;
          const dist = Math.sqrt(dx * dx + dy * dy) || 1;
          const force = repulsion / (dist * dist);
          const fx = (dx / dist) * force;
          const fy = (dy / dist) * force;
          notes[i].vx -= fx;
          notes[i].vy -= fy;
          notes[j].vx += fx;
          notes[j].vy += fy;
        }
      }

      // Attraction along links
      links.forEach(link => {
        const dx = link.to.x - link.from.x;
        const dy = link.to.y - link.from.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const desiredDist = 200; // Increased desired distance between linked nodes
        const force = (dist - desiredDist) * attraction;
        const fx = (dx / dist) * force;
        const fy = (dy / dist) * force;
        
        if (!link.from.isDragging) {
          link.from.vx += fx;
          link.from.vy += fy;
        }
        if (!link.to.isDragging) {
          link.to.vx -= fx;
          link.to.vy -= fy;
        }
      });

      // Center pull and update positions
      notes.forEach(note => {
        if (note.isDragging) {
          note.vx = 0;
          note.vy = 0;
          return;
        }
        
        note.vx += -note.x * centerPull;
        note.vy += -note.y * centerPull;
        note.vx *= damping;
        note.vy *= damping;
        note.x += note.vx;
        note.y += note.vy;
      });
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw grid dots
      const gridSize = 40;
      const dotRadius = 1.5;
      ctx.fillStyle = '#333333';
      
      const startX = Math.floor(((-camera.x - canvas.width / 2 / camera.zoom) / gridSize)) * gridSize;
      const startY = Math.floor(((-camera.y - canvas.height / 2 / camera.zoom) / gridSize)) * gridSize;
      const endX = startX + canvas.width / camera.zoom + gridSize * 2;
      const endY = startY + canvas.height / camera.zoom + gridSize * 2;
      
      for (let x = startX; x < endX; x += gridSize) {
        for (let y = startY; y < endY; y += gridSize) {
          const screen = worldToScreen(x, y);
          ctx.beginPath();
          ctx.arc(screen.x, screen.y, dotRadius, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // Draw links
      ctx.strokeStyle = '#555';
      ctx.lineWidth = 2;
      links.forEach(link => {
        const from = worldToScreen(link.from.x, link.from.y);
        const to = worldToScreen(link.to.x, link.to.y);
        ctx.beginPath();
        ctx.moveTo(from.x, from.y);
        ctx.lineTo(to.x, to.y);
        ctx.stroke();
      });

      // Draw notes
      notes.forEach(note => {
        const pos = worldToScreen(note.x, note.y);
        
        // Node circle
        ctx.fillStyle = '#a78bfa';
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, note.radius * camera.zoom, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();

        // Title
        if (note.title) {
          ctx.fillStyle = '#e0e0e0';
          ctx.font = `${12 * camera.zoom}px Arial`;
          ctx.textAlign = 'center';
          ctx.fillText(note.title, pos.x, pos.y + (note.radius + 15) * camera.zoom);
        }
      });
    }

    function getNoteAt(sx, sy) {
      const world = screenToWorld(sx, sy);
      for (let note of notes) {
        const dx = world.x - note.x;
        const dy = world.y - note.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < note.radius) {
          return note;
        }
      }
      return null;
    }

    function animate() {
      applyForces();
      draw();
      requestAnimationFrame(animate);
    }

    function showContextMenu(x, y, note) {
      removeContextMenu();
      contextMenu = document.createElement('div');
      contextMenu.className = 'context-menu';
      
      // On mobile, center the menu on screen instead of at tap position
      if (isMobile) {
        contextMenu.style.left = '50%';
        contextMenu.style.top = '50%';
        contextMenu.style.transform = 'translate(-50%, -50%)';
      } else {
        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';
      }

      if (note) {
        const addLinkItem = document.createElement('div');
        addLinkItem.className = 'context-menu-item';
        addLinkItem.textContent = 'Add Link';
        addLinkItem.onclick = () => {
          removeContextMenu();
          startLinkCreation(note);
        };
        contextMenu.appendChild(addLinkItem);

        const deleteItem = document.createElement('div');
        deleteItem.className = 'context-menu-item';
        deleteItem.textContent = 'Delete Note';
        deleteItem.onclick = () => {
          removeContextMenu();
          deleteNote(note);
        };
        contextMenu.appendChild(deleteItem);
      } else {
        const newNoteItem = document.createElement('div');
        newNoteItem.className = 'context-menu-item';
        newNoteItem.textContent = 'New Note';
        newNoteItem.onclick = () => {
          removeContextMenu();
          const world = screenToWorld(x, y);
          createNote(world.x, world.y);
        };
        contextMenu.appendChild(newNoteItem);
      }

      document.body.appendChild(contextMenu);
    }

    function removeContextMenu() {
      if (contextMenu) {
        contextMenu.remove();
        contextMenu = null;
      }
    }

    // Close context menu when clicking/tapping outside
    function setupContextMenuCloseHandler() {
      const closeHandler = (e) => {
        if (contextMenu && !contextMenu.contains(e.target)) {
          removeContextMenu();
          document.removeEventListener('click', closeHandler);
          document.removeEventListener('touchend', closeHandler);
        }
      };
      
      // Add listeners after a tiny delay to prevent immediate closure
      setTimeout(() => {
        document.addEventListener('click', closeHandler);
        document.addEventListener('touchend', closeHandler);
      }, 100);
    }

    function showNoteEditor(note, onSave, mode = 'edit', scrollToText = null) {
      removeNoteEditor();
      removeLinksPopup();
      
      noteEditor = document.createElement('div');
      noteEditor.className = 'note-editor active';
      
      // Get links for this note
      const noteLinks = getLinksForNote(note);
      let displayContent = note.content;
      
      if (mode === 'edit') {
        // Render linked text as purple
        displayContent = renderLinkedText(note.content, noteLinks, note);
      }
      
      const html = `
        <div class="note-editor-header">
          <input type="text" class="note-editor-title" placeholder="Title" value="${note.title}">
        </div>
        <div class="note-editor-body">
          <div class="note-editor-content" contenteditable="true">${displayContent}</div>
        </div>
        <div class="note-editor-toolbar">
          <button class="toolbar-btn" data-format="bold"><b>B</b></button>
          <button class="toolbar-btn" data-format="italic"><i>I</i></button>
          <button class="toolbar-btn" data-format="underline"><u>U</u></button>
        </div>
        <div class="note-editor-footer">
          <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button class="btn btn-primary" id="saveBtn">${mode === 'select' ? 'Confirm' : 'Save'}</button>
        </div>
      `;
      
      noteEditor.innerHTML = html;
      document.body.appendChild(noteEditor);

      const titleInput = noteEditor.querySelector('.note-editor-title');
      const contentArea = noteEditor.querySelector('.note-editor-content');
      const saveBtn = noteEditor.querySelector('#saveBtn');
      const cancelBtn = noteEditor.querySelector('#cancelBtn');

      // Handle right-clicks on linked text
      if (mode === 'edit') {
        contentArea.addEventListener('contextmenu', (e) => {
          const target = e.target.closest('.linked-text');
          if (target) {
            e.preventDefault();
            const linkText = target.textContent;
            showLinksPopup(e.clientX, e.clientY, note, linkText);
          }
        });
      }

      // Scroll to specific text if provided
      if (scrollToText && mode === 'edit') {
        setTimeout(() => {
          const linkedSpans = contentArea.querySelectorAll('.linked-text');
          for (let span of linkedSpans) {
            if (span.textContent === scrollToText) {
              span.scrollIntoView({ behavior: 'smooth', block: 'center' });
              span.style.background = 'rgba(124, 58, 237, 0.3)';
              setTimeout(() => {
                span.style.background = 'rgba(1